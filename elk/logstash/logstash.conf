input {
  # TCP input for receiving logs
  tcp {
    port => 5000
    codec => json_lines
  }
  
  # HTTP input for API logs
  http {
    port => 5001
    codec => json_lines
  }
  
  # File input for Sysmon logs
  file {
    path => "/app/data/*.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse timestamps
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }
  
  # Add geoip for IP addresses
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "geoip"
    }
  }
  
  # Add risk level
  if [risk_score] {
    mutate {
      add_field => {
        "risk_level" => "%{risk_score}"
      }
    }
    
    if [risk_score] > 80 {
      mutate {
        add_field => { "alert_level" => "critical" }
      }
    } else if [risk_score] > 60 {
      mutate {
        add_field => { "alert_level" => "high" }
      }
    } else if [risk_score] > 40 {
      mutate {
        add_field => { "alert_level" => "medium" }
      }
    } else {
      mutate {
        add_field => { "alert_level" => "low" }
      }
    }
  }
  
  # Add @metadata for index routing
  mutate {
    add_field => {
      "[@metadata][index]" => "insider-threat-%{+YYYY.MM.dd}"
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    user => "elastic"
    password => "changeme"
  }
  
  # Output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}